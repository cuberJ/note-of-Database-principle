# 视图与索引



## 视图

通过查询来定义虚关系，相当于固定了一个查询方式，但并不会保留查询结果

```mysql
# 找出2009年物理系开设的课程和上课教室
create view Physics_2009 as 
select course_id, buliding, room_number
from course, section
where course.deptname = 'Physics' and 
	course.course_id = section.course_id and 
	course.year = 2009
```

视图本身可以视为一个关系表

```mysql
select course_id 
from Physics_2009
where course_id = '123'
```



### 视图的插入

```mysql
# insert a new tunple to the view named 'faculty'
insert into faculty values('12345', 'Green', 'Music', null);
# 如果最后的null没有写上去，那么有可能会返回一个错误信息并拒绝插入
```

1. 新插入视图的数据中，可能包含不存在的外键，这时候需要检查视图是否可更新

   ```mysql
   insert into instructor_info values('69987', 'White', 'Taylor');
   # 假如没有69987为ID的职工，也没有位于Taylor大楼的教室。如果直接去原始表更新building的数据库，由于该表中能填入的有效信息只有一个Taylor，可能会出现主键为null的情况
   ```

   检查视图是否可更新的条件：updatable，才可以执行插入，更新和删除，需要同时满足下面四个条件

   1. from子句只有一个数据库关系
   2. select不包含计算结果，聚合函数以及distinct
   3. 查询中没有group by
   4. 没有出现在select中的属性可以取null



2. 就算视图满足四个条件，但可能会在更新的时候出现数据不符合定义的错误，此时需要使用`with check option`
   ![image-20210114114237790](image-20210114114237790.png)



### 物化视图

为了提高常用视图的访问效率，引入物化视图。物化后的视图会将检索的结果保留在数据库中

#### 物化视图维护

共有三种维护方式

1. 视图的定义被更新时，进行视图维护
2. 视图被访问的时候，进行视图维护
3. 周期性视图维护（可能会有过时数据）

## 索引

为属性创建索引，可以方便找到在索引属性上取给定值的元组

```mysql
create unique index ID_index on student(ID) # 给学生表中的ID属性创建唯一索引
drop index ID_index # 删除索引
```

1. 唯一索引`unique index` 只能为==主键==创建。唯一索引表示，该属性下，每个索引只对应一个元组。所以也只能对主键创建，否则会有重复
2. 索引可以由表的管理员或者DBMS创建，维护通常由DBMS完成



### 索引实现

通常由B+树或者hash索引完成

1.  B+树可以动态平衡，hash的查找速度快



### 聚簇索引

指索引顺序与表中物理顺序一致的索引。聚簇索引的最大特点是：<font color = red>索引本身是和数据连在一起的，找到索引就是找到了数据</font>

1. 在最常查询的列上建立聚簇索引可以最大提升查询效率
2. 一个基本表只能建立最多一个聚簇索引
3. 经常更新的表不适合建立聚簇索引



## 数据字典

记录了数据库中所有的定义信息，包括索引定义，模式定义，约束定义，权限，统计信息等

执行sQL数据定义的时候，实际就是更新数据字典